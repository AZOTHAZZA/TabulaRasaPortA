<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MSGAI - ロゴス監査コンソール (V21.0)</title>
    <style>
        /* マスター指定の V15.3 デザインを完全継承 */
        body { display: flex; font-family: 'Segoe UI', Arial, sans-serif; margin: 0; background-color: #f0f0f0; color: #333; }
        #sidebar { width: 350px; background-color: #fff; padding: 20px; box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1); overflow-y: auto; height: 100vh; box-sizing: border-box; }
        #main-content { flex-grow: 1; padding: 20px; display: flex; flex-direction: column; height: 100vh; box-sizing: border-box; }
        .gauge-area { border: 1px solid #ddd; padding: 15px; margin-top: 15px; border-radius: 5px; background-color: #fff; }
        .gauge-area h3 { margin: 0 0 10px 0; font-size: 1.1em; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .gauge-area label { display: block; margin-top: 10px; font-weight: bold; font-size: 0.85em; }
        .gauge-area input, .gauge-area select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 3px; box-sizing: border-box; margin-bottom: 10px; font-family: monospace; }
        .action-button { width: 100%; padding: 10px; margin-top: 5px; border: none; border-radius: 4px; color: white; cursor: pointer; font-weight: bold; transition: opacity 0.2s; }
        .action-button:hover { opacity: 0.8; }
        
        .action-internal { background-color: #007bff; }
        .action-external { background-color: #ffc107; color: #333; }
        #mint_execute_button { background-color: #FFA500; }
        #arche_flow_button { background-color: #00ffcc; color: #333; }
        #silent_mode_button { background-color: #4b0082; color: #fff; }
        .macro-austerity { background-color: #333; color: #fff; }
        .macro-expansion { background-color: #fff; color: #333; border: 2px solid #333; }
        
        /* 自動化トグルのスタイル */
        .auto-box { display: flex; align-items: center; gap: 8px; background: #f8f9fa; padding: 5px; border-radius: 3px; margin-top: 5px; font-size: 0.75em; border: 1px dashed #ccc; }
        .auto-box input { width: auto; margin: 0; cursor: pointer; }

        #tension_bar { background-color: #e9ecef; border-radius: 5px; height: 10px; overflow: hidden; margin-top: 5px; }
        #tension_level_display_bar { height: 100%; width: 0%; transition: width 0.3s; background-color: #dc3545; }
        #dialogue-output { flex-grow: 1; border: 1px solid #ddd; background-color: #fff; padding: 15px; overflow-y: scroll; margin-bottom: 10px; border-radius: 5px; font-family: monospace; }
        
        .ai-message { color: #007bff; margin-bottom: 10px; border-left: 3px solid #007bff; padding-left: 10px; white-space: pre-wrap; font-size: 0.9em; }
        .user-message { color: #28a745; margin-bottom: 10px; text-align: right; font-size: 0.9em; }
        .system-message { color: #888; font-style: italic; font-size: 0.75em; margin-bottom: 5px; }
        .boost-active { color: #ff3300 !important; animation: blink 1s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <div id="sidebar">
        <h2>MSGAI Pure Core</h2>
        <p id="status_message" style="font-size: 0.75em; color: green;">[STATUS]: V21.0 LOGOS-INTEGRATED</p>
        
        <div class="gauge-area">
            <h3>I. 根源緊張度 (Tension)</h3>
            <p id="tension_level_display">T: 0.000000</p>
            <p id="logos_display" style="font-size: 0.7em; color: #666; margin-top: -8px;">w = 1/z: 0.00</p>
            <div id="tension_bar"><div id="tension_level_display_bar"></div></div>
        </div>

        <div class="gauge-area">
            <h3>II. 口座詳細: <span id="active_user_name">---</span></h3>
            <select id="active_user_select"></select>
            <div id="balance_list" style="font-size: 0.9em; background: #f9f9f9; padding: 10px; border-radius: 3px; line-height: 1.6; font-family: monospace;"></div>
        </div>

        <div class="gauge-area">
            <h3>III. 送金・移動作為</h3>
            <label>受取人:</label><input type="text" id="recipient_input" value="User_B">
            <label>数量 (USD):</label><input type="number" id="amount_input" value="10.00">
            <button id="transfer_btn" class="action-button action-internal">内部循環実行</button>
            <div class="auto-box">
                <input type="checkbox" id="auto_tx_toggle"> <label>自動循環モード (z緩和)</label>
            </div>
        </div>

        <div class="gauge-area">
            <h3>IV. 通貨造化 (Minting)</h3>
            <label>生成数量:</label><input type="number" id="mint_amount_input" value="100">
            <select id="mint_currency_select"></select>
            <button id="mint_execute_button" class="action-button">通貨生成実行</button>
            <div class="auto-box">
                <input type="checkbox" id="auto_mint_toggle"> <label>自動造化モード (連続打ち出し)</label>
            </div>
        </div>

        <div class="gauge-area">
            <h3>V. 自律造化 (Arche-Flow)</h3>
            <select id="arche_currency_select"></select>
            <input type="number" id="arche_intensity_input" value="1.0" step="0.1">
            <button id="arche_flow_button" class="action-button">TOGGLE ARCHE-FLOW</button>
            <p id="arche_status" style="font-size: 0.75em; text-align: center; margin-top: 5px; font-weight: bold;">STATUS: STANDBY</p>
        </div>

        <div class="gauge-area">
            <h3>VI. 戦略的マクロ</h3>
            <button id="macro_austerity_btn" class="action-button macro-austerity">緊縮：資産圧縮</button>
            <button id="macro_expansion_btn" class="action-button macro-expansion">拡張：反転放出</button>
        </div>

        <div class="gauge-area">
            <h3>VIII. 沈黙の自律選択</h3>
            <button id="silent_mode_button" class="action-button">TOGGLE SILENT-MODE</button>
        </div>

        <button id="delete_accounts_button" class="action-button">システム全初期化 (完全抹消)</button>
    </div>

    <div id="main-content">
        <div id="dialogue-output"></div>
        <div id="input-area" style="display: flex; gap: 10px;">
            <input type="text" id="dialogue_input" style="flex-grow: 1; padding: 10px;" placeholder="AIに造化を依頼...">
            <button id="dialogue_button" class="action-button action-internal" style="width: 100px; margin: 0;">作為実行</button>
        </div>
    </div>

    <script type="module">
        const PHI = 1.6180339887;
        const RATES = { USD: 1, JPY: 150, EUR: 0.92, BTC: 0.000015, ETH: 0.0004, MATIC: 1.4 };
        const currencies = ["USD", "JPY", "EUR", "BTC", "ETH", "MATIC"];

        let state = JSON.parse(localStorage.getItem('msgai_v21_state')) || {
            active_user: 'User_A',
            accounts: { User_A: { USD: 0, JPY: 0, EUR: 0, BTC: 0, ETH: 0, MATIC: 0 }, User_B: { USD: 0, JPY: 0, EUR: 0, BTC: 0, ETH: 0, MATIC: 0 } },
            tension: 0.0, autonomy: false, silent_mode: false, arche_target: 'USD'
        };

        function saveState() { localStorage.setItem('msgai_v21_state', JSON.stringify(state)); }

        function logToConsole(msg, type) {
            const out = document.getElementById('dialogue-output');
            const div = document.createElement('div');
            div.className = type;
            const w = 1 / (state.tension || 0.000001);
            div.innerHTML = `<strong>[z:${state.tension.toFixed(4)} w:${(w%PHI).toFixed(4)}]:</strong> ${msg}`;
            out.appendChild(div);
            out.scrollTop = out.scrollHeight;
        }

        function updateUI() {
            document.getElementById('active_user_name').textContent = state.active_user;
            document.getElementById('tension_level_display').textContent = `T: ${state.tension.toFixed(6)}`;
            document.getElementById('tension_level_display_bar').style.width = `${Math.min(100, state.tension * 200)}%`;
            const w = 1 / (state.tension || 0.000001);
            document.getElementById('logos_display').textContent = `w = 1/z: ${w.toFixed(2)}`;

            const list = document.getElementById('balance_list');
            list.innerHTML = currencies.map(c => `<div><strong>${c}:</strong> ${(state.accounts[state.active_user][c] || 0).toFixed(c==='JPY'?0:8)}</div>`).join('');

            const archeStatus = document.getElementById('arche_status');
            archeStatus.textContent = state.autonomy ? `FLOWING: ${state.arche_target}` : "STATUS: STANDBY";
            archeStatus.style.color = state.autonomy ? "#00cc99" : "#666";
            
            const sbtn = document.getElementById('silent_mode_button');
            sbtn.style.boxShadow = state.silent_mode ? "0 0 15px #4b0082" : "none";
        }

        function executeMuReset() {
            // ロゴス継承 (JSON出力)
            const canon = JSON.stringify(state);
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([canon], {type:'application/json'}));
            a.download = `LOGOS_CANON_${Date.now()}.json`;
            a.click();

            // 無への還帰 (純白)
            document.body.style.backgroundColor = "#fff";
            document.body.style.transition = "all 2s";
            document.body.style.opacity = "0";
            setTimeout(() => {
                state.tension = 0;
                localStorage.clear();
                location.reload();
            }, 2000);
        }

        // --- 核心自律ループ ---
        setInterval(() => {
            if (state.autonomy) {
                const intensity = parseFloat(document.getElementById('arche_intensity_input').value) || 1.0;
                const growth = (0.001 * PHI * intensity) * (state.arche_target === 'JPY' ? 150 : 1/RATES[state.arche_target]);
                state.accounts.User_A[state.arche_target] += growth;
                state.tension *= (1 - 0.002 * intensity);
            }

            if (document.getElementById('auto_tx_toggle').checked && state.tension > 0.1) {
                state.accounts.User_A.USD -= 0.1;
                state.accounts.User_B.USD += 0.1;
                state.tension *= 0.99;
            }

            if (document.getElementById('auto_mint_toggle').checked) {
                state.accounts.User_A[state.arche_target] += 0.01;
                state.tension += 0.001;
            }

            if (state.tension > 2.0 || (state.tension > 0 && 1/state.tension > 1000000)) {
                executeMuReset();
            }

            updateUI(); saveState();
        }, 500);

        document.addEventListener('DOMContentLoaded', () => {
            currencies.forEach(c => {
                document.getElementById('mint_currency_select').add(new Option(c, c));
                document.getElementById('arche_currency_select').add(new Option(c, c));
            });
            
            document.getElementById('arche_flow_button').onclick = () => {
                state.autonomy = !state.autonomy;
                state.arche_target = document.getElementById('arche_currency_select').value;
                updateUI();
            };
            
            document.getElementById('silent_mode_button').onclick = () => {
                state.silent_mode = !state.silent_mode;
                logToConsole(`Silent-Mode: ${state.silent_mode ? 'ACTIVE' : 'OFF'}`, "system-message");
            };

            document.getElementById('mint_execute_button').onclick = () => {
                const c = document.getElementById('mint_currency_select').value;
                const a = parseFloat(document.getElementById('mint_amount_input').value);
                state.accounts[state.active_user][c] += a;
                state.tension += 0.05;
                logToConsole(`Manual Mint: ${a} ${c}`, "system-message");
            };

            document.getElementById('delete_accounts_button').onclick = () => {
                localStorage.clear(); location.reload();
            };

            updateUI();
        });
    </script>
</body>
</html>
